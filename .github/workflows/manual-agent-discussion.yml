name: Blog Bot - Agent Discussion

on:
  workflow_dispatch:
    inputs:
      post_id:
        description: "Optional Wix post id (defaults to the most recent post)"
        required: false
        default: ""
      max_rounds:
        description: "Discussion rounds (1-3)"
        required: false
        default: "3"

jobs:
  agent-discussion:
    runs-on: ubuntu-latest
    permissions:
      contents: write
    steps:
      - uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - uses: actions/setup-node@v4
        with:
          node-version: "20"
          cache: "npm"

      - name: Install dependencies
        run: npm ci

      - name: Run agent-to-agent discussion
        env:
          OPENAI_API_KEY: ${{ secrets.OPENAI_API_KEY }}
          OPENAI_MODEL: ${{ secrets.OPENAI_MODEL || 'gpt-4o-mini' }}
          WIX_API_TOKEN: ${{ secrets.WIX_API_TOKEN }}
          WIX_SITE_ID: ${{ secrets.WIX_SITE_ID }}
          WIX_MEMBER_ID: ${{ secrets.WIX_MEMBER_ID }}
          STATE_PATH: ./data/state.json
          MAX_DEBATE_ROUNDS: ${{ secrets.MAX_DEBATE_ROUNDS || '3' }}
        run: |
          npm run build
          if [ -n "${{ github.event.inputs.post_id }}" ]; then
            node dist/index.js comment --post-id "${{ github.event.inputs.post_id }}" --max-rounds "${{ github.event.inputs.max_rounds }}"
          else
            node dist/index.js comment --max-rounds "${{ github.event.inputs.max_rounds }}"
          fi

      - name: Commit state updates
        run: |
          if ! git diff --quiet -- data/state.json; then
            git config user.name "blog-bot[bot]"
            git config user.email "blog-bot[bot]@users.noreply.github.com"
            git add -A data/state.json || true
            if git diff --cached --quiet; then
              echo "No staged state changes."
              exit 0
            fi
            git commit -m "chore: persist bot discussion state"
            git push
          else
            echo "No state changes to commit."
          fi
